# Phase 3.3 - Auto-Evolution Manager Design

## Vue d'ensemble

Le **Auto-Evolution Manager** est le syst√®me qui permet √† Cortex de **cr√©er dynamiquement** de nouveaux composants (d√©partements, agents, outils) bas√© sur l'analyse des patterns d'utilisation.

## Principe fondamental

> **"Si une t√¢che est demand√©e 3+ fois et qu'il n'existe pas d'agent sp√©cialis√©, cr√©er automatiquement cet agent."**

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Auto-Evolution Manager                      ‚îÇ
‚îÇ  (Analyse patterns ‚Üí D√©cide √©volutions ‚Üí G√©n√®re composants) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ                 ‚îÇ                 ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Department ‚îÇ   ‚îÇ    Agent    ‚îÇ   ‚îÇ    Tool    ‚îÇ
    ‚îÇ  Evolver   ‚îÇ   ‚îÇ   Evolver   ‚îÇ   ‚îÇ  Evolver   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                 ‚îÇ                 ‚îÇ
          ‚îÇ                 ‚îÇ                 ‚îÇ
    Creates new       Creates new       Creates new
    departments       agents with       bash tools
    when needed       specific roles    as needed
```

## Composants

### 1. PatternDetector

**R√¥le**: Analyse l'historique pour identifier patterns r√©currents

**D√©tecte**:
- T√¢ches demand√©es 3+ fois sans agent sp√©cialis√©
- Workflows r√©p√©titifs qui pourraient √™tre automatis√©s
- Combinaisons d'outils souvent utilis√©es ensemble
- Nouveaux domaines d'expertise n√©cessaires

**M√©triques utilis√©es**:
```python
{
    "request_frequency": int,          # Combien de fois demand√©
    "success_rate": float,             # Taux de succ√®s actuel
    "avg_duration": float,             # Temps moyen
    "agents_involved": List[str],      # Agents actuellement utilis√©s
    "tools_used": List[str],           # Outils utilis√©s
    "keywords": List[str],             # Mots-cl√©s r√©currents
    "complexity_score": float          # Score de complexit√©
}
```

**D√©cision**: Pattern d√©tect√© si:
- `request_frequency >= 3`
- `success_rate < 0.7` (pourrait √™tre am√©lior√©)
- OU `avg_duration > threshold` (pourrait √™tre optimis√©)

### 2. DepartmentEvolver

**R√¥le**: Cr√©e de nouveaux d√©partements dynamiquement

**Crit√®res de cr√©ation**:
- 5+ agents travaillent souvent ensemble sur m√™me type de t√¢che
- Nouveau domaine d'expertise identifi√© (ex: "security", "performance")
- Besoin de knowledge base partag√©e sp√©cialis√©e

**Processus de cr√©ation**:
1. D√©tecte besoin via PatternDetector
2. G√©n√®re nom et description du d√©partement
3. Cr√©e structure de fichiers:
   ```
   cortex/departments/<nom>/
   ‚îú‚îÄ‚îÄ __init__.py
   ‚îú‚îÄ‚îÄ <agent1>.py
   ‚îú‚îÄ‚îÄ <agent2>.py
   ‚îî‚îÄ‚îÄ knowledge_base.json
   ```
4. Migre agents existants pertinents
5. Initialise knowledge base

**Template d√©partement**:
```python
class NewDepartment:
    """
    Description auto-g√©n√©r√©e bas√©e sur patterns
    """
    name: str
    description: str
    agents: List[Agent]
    knowledge_base: DepartmentKnowledgeBase
    created_at: datetime
    created_by: str = "AutoEvolutionManager"
    creation_reason: str  # Justification de cr√©ation
```

### 3. AgentEvolver

**R√¥le**: Cr√©e de nouveaux agents avec r√¥les sp√©cialis√©s

**Crit√®res de cr√©ation**:
- Pattern identifi√© avec `request_frequency >= 3`
- Pas d'agent sp√©cialis√© existant
- Potentiel d'am√©lioration significatif (success_rate ou duration)

**Niveaux d'agents g√©n√©r√©s**:
- **EX√âCUTANT**: T√¢ches simples et r√©p√©titives
- **EXPERT**: T√¢ches complexes n√©cessitant analyse
- **DIRECTEUR**: Orchestration de plusieurs agents

**Processus de cr√©ation**:
1. Analyse pattern d√©tect√©
2. D√©termine niveau appropri√© (EX√âCUTANT/EXPERT/DIRECTEUR)
3. G√©n√®re nom bas√© sur fonction (ex: "SecurityAuditorExpert")
4. Cr√©e fichier agent avec:
   - Description auto-g√©n√©r√©e
   - M√©thodes bas√©es sur actions pattern
   - Int√©gration Optimization
   - Tests unitaires auto-g√©n√©r√©s
5. Enregistre dans DepartmentRegistry
6. Ajoute √† roadmap pour revue manuelle

**Template agent**:
```python
class AutoGeneratedAgent:
    """
    Agent auto-g√©n√©r√© pour: <description>

    Cr√©√© le: <datetime>
    Raison: <pattern detected>
    Requ√™tes similaires: <count>
    Success rate attendu: <prediction>
    """
    name: str
    role: AgentRole  # EX√âCUTANT/EXPERT/DIRECTEUR
    department: str
    specialization: str
    capabilities: List[str]
    tools_available: List[str]
    created_by: str = "AgentEvolver"

    def execute(self, task: Task) -> TaskResult:
        # Impl√©mentation auto-g√©n√©r√©e bas√©e sur pattern
        pass
```

### 4. ToolEvolver

**R√¥le**: G√©n√®re outils bash r√©utilisables

**Crit√®res de cr√©ation**:
- Commande bash utilis√©e 3+ fois
- Pattern de commandes combin√©es r√©current
- Besoin d'abstraction pour complexit√©

**Types d'outils g√©n√©r√©s**:
1. **Simple wrapper**: Encapsule commande unique avec param√®tres
2. **Pipeline**: Combine plusieurs commandes
3. **Script complexe**: Logique conditionnelle

**Processus de cr√©ation**:
1. D√©tecte commandes r√©currentes
2. Extrait param√®tres variables
3. G√©n√®re script bash avec:
   - Validation param√®tres
   - Error handling
   - Documentation inline
   - Usage examples
4. Cr√©e tests automatiques
5. Sauvegarde dans `cortex/tools/generated/`
6. Enregistre dans ToolRegistry

**Template outil**:
```bash
#!/bin/bash
# Auto-generated tool: <name>
# Created: <datetime>
# Purpose: <description>
# Usage: ./<name>.sh <param1> <param2>
#
# Generated by ToolEvolver based on pattern:
#   Used <count> times in <contexts>
#   Success rate: <rate>

set -euo pipefail

# Parameter validation
if [ $# -lt <required> ]; then
    echo "Usage: $0 <params>"
    exit 1
fi

# Main logic (auto-generated from pattern)
<commands>

# Error handling
if [ $? -ne 0 ]; then
    echo "Error: <description>"
    exit 1
fi

echo "Success: <description>"
```

### 5. AutoEvolutionManager (Orchestrateur)

**R√¥le**: Coordonne tous les Evolvers

**Workflow**:
```
1. P√©riodiquement (ou sur demande):
   ‚îú‚îÄ> PatternDetector analyse historique
   ‚îî‚îÄ> Identifie patterns avec potential

2. Pour chaque pattern d√©tect√©:
   ‚îú‚îÄ> D√©termine type d'√©volution n√©cessaire
   ‚îÇ   ‚îú‚îÄ> Nouveau d√©partement?
   ‚îÇ   ‚îú‚îÄ> Nouvel agent?
   ‚îÇ   ‚îî‚îÄ> Nouvel outil?
   ‚îÇ
   ‚îú‚îÄ> Calcule ROI estim√©:
   ‚îÇ   ‚îî‚îÄ> (time_saved * frequency) - creation_cost
   ‚îÇ
   ‚îî‚îÄ> Si ROI > threshold:
       ‚îú‚îÄ> G√©n√®re composant
       ‚îú‚îÄ> Cr√©e tests automatiques
       ‚îú‚îÄ> Ajoute √† roadmap pour revue
       ‚îî‚îÄ> Envoie alerte CEO

3. G√©n√®re rapport d'√©volution:
   ‚îî‚îÄ> Liste tous les composants cr√©√©s avec justifications
```

**M√©triques de d√©cision**:
```python
class EvolutionDecision:
    pattern_id: str
    evolution_type: str  # "department", "agent", "tool"
    estimated_time_saved: float  # heures/semaine
    creation_cost: float         # heures de cr√©ation
    roi: float                   # time_saved / creation_cost
    confidence: float            # confiance dans la d√©cision
    recommended: bool            # ROI > threshold
    justification: str
```

## S√©curit√© et Validation

### Contraintes strictes:

1. **Aucune √©volution automatique sans validation**:
   - Tous les composants g√©n√©r√©s sont ajout√©s au roadmap
   - Alerte CEO envoy√©e pour revue
   - Tests automatiques g√©n√©r√©s pour validation

2. **Limitation des g√©n√©rations**:
   - Maximum 3 nouveaux composants par jour
   - Revue manuelle requise avant activation
   - P√©riode d'observation de 7 jours minimum

3. **Sandbox pour nouveaux composants**:
   - Ex√©cut√©s dans environnement isol√©
   - M√©triques collect√©es avant promotion
   - Rollback automatique si √©chec

## Exemple concret

### Sc√©nario: Besoin d√©tect√©

```python
# PatternDetector trouve:
{
    "pattern_name": "security_audit_requests",
    "frequency": 8,  # Demand√© 8 fois
    "success_rate": 0.625,  # 62.5% succ√®s (pourrait √™tre am√©lior√©)
    "avg_duration": 1800,  # 30 minutes en moyenne
    "keywords": ["security", "audit", "vulnerabilities", "scan"],
    "agents_involved": ["CodeAnalystExpert", "DeveloperAgent"],
    "tools_used": ["grep", "find", "git grep"]
}
```

### D√©cision: Cr√©er agent sp√©cialis√©

```python
# AgentEvolver g√©n√®re:
class SecurityAuditorExpert:
    """
    Agent sp√©cialis√© en audits de s√©curit√©

    Cr√©√© automatiquement le 2025-10-15
    Raison: 8 requ√™tes similaires d√©tect√©es avec success rate 62.5%

    Am√©lioration estim√©e:
    - Success rate: 62.5% ‚Üí 95% (agents sp√©cialis√©s)
    - Duration: 30min ‚Üí 10min (automatisation)
    - ROI: 2.67 heures/semaine
    """

    def audit_security(self, codebase_path: str) -> AuditReport:
        # 1. Scan for common vulnerabilities
        # 2. Check dependencies for CVEs
        # 3. Analyze authentication/authorization
        # 4. Generate detailed report
        pass
```

### R√©sultat:

- Agent cr√©√© dans `cortex/departments/security/security_auditor.py`
- Tests g√©n√©r√©s dans `tests/test_security_auditor.py`
- Ajout√© au roadmap pour revue
- Alerte CEO envoy√©e:
  ```
  üü¢ New Agent Created: SecurityAuditorExpert
  Reason: 8 similar requests, 62.5% success rate
  Expected improvement: 95% success, 10min vs 30min
  ROI: 2.67 hours/week
  Action required: Review and approve in roadmap
  ```

## M√©triques de succ√®s

Le syst√®me d'auto-√©volution est consid√©r√© r√©ussi si:

1. **Taux d'acceptation**: >80% des composants g√©n√©r√©s sont valid√©s
2. **ROI r√©el**: √âconomies mesur√©es >= estimations
3. **Qualit√©**: Composants g√©n√©r√©s passent tests automatiques
4. **Pertinence**: Composants sont effectivement utilis√©s apr√®s cr√©ation

## Impl√©mentation Phase 3.3

### Ordre d'impl√©mentation:

1. ‚úÖ **PatternDetector** - D√©tection de patterns
2. ‚úÖ **ToolEvolver** - G√©n√©ration d'outils (plus simple)
3. ‚úÖ **AgentEvolver** - G√©n√©ration d'agents
4. ‚úÖ **DepartmentEvolver** - G√©n√©ration de d√©partements
5. ‚úÖ **AutoEvolutionManager** - Orchestration compl√®te
6. ‚úÖ **Tests d'int√©gration** - Validation syst√®me complet

### Fichiers √† cr√©er:

```
cortex/core/auto_evolution/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ pattern_detector.py       # D√©tection patterns
‚îú‚îÄ‚îÄ evolution_decision.py     # D√©cisions ROI
‚îú‚îÄ‚îÄ tool_evolver.py           # G√©n√©ration outils
‚îú‚îÄ‚îÄ agent_evolver.py          # G√©n√©ration agents
‚îú‚îÄ‚îÄ department_evolver.py     # G√©n√©ration d√©partements
‚îî‚îÄ‚îÄ auto_evolution_manager.py # Orchestrateur

cortex/tools/generated/       # Outils g√©n√©r√©s automatiquement
‚îî‚îÄ‚îÄ .gitignore               # Ne pas commit outils auto

tests/
‚îî‚îÄ‚îÄ test_phase3_3_auto_evolution.py
```

## Notes importantes

- **Tous les composants g√©n√©r√©s portent mention "Auto-generated"**
- **Revue manuelle obligatoire avant activation**
- **M√©triques collect√©es pour validation continue**
- **Possibilit√© de d√©sactiver/supprimer facilement**
- **Documentation auto-g√©n√©r√©e avec justifications**

---

**Phase 3.3 permettra √† Cortex de vraiment "√©voluer" de mani√®re autonome, cr√©ant les outils et agents dont il a besoin bas√© sur l'exp√©rience.**
